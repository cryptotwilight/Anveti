<!DOCTYPE html>
<html lang="en">

<head>
    <title>Anveti - IPFS Search on Web 3</title>
    <!-- HTML5 Shim and Respond.js IE11 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 11]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Free Datta Able Admin Template come up with latest Bootstrap 4 framework with basic components, form elements and lots of pre-made layout options" />
    <meta name="keywords" content="admin templates, bootstrap admin templates, bootstrap 4, dashboard, dashboard templets, sass admin templets, html admin templates, responsive, bootstrap admin templates free download,premium bootstrap admin templates, datta able, datta able bootstrap admin template, free admin theme, free dashboard template"/>
    <meta name="author" content="CodedThemes"/>

    <!-- Favicon icon -->
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <!-- fontawesome icon -->
    <link rel="stylesheet" href="assets/fonts/fontawesome/css/fontawesome-all.min.css">
    <!-- animation css -->
    <link rel="stylesheet" href="assets/plugins/animation/css/animate.min.css">
    <!-- vendor css -->
    <link rel="stylesheet" href="assets/css/style.css">

    <script src="https://unpkg.com/ipfs-http-client-lite/dist/index.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <!-- [ Pre-loader ] start -->
    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>
    <!-- [ Pre-loader ] End -->
    <!-- [ navigation menu ] start -->
    <nav class="pcoded-navbar">
        <div class="navbar-wrapper">
            <div class="navbar-brand header-logo">
                <a href="index.html" class="b-brand">
                    <div class="b-bg">
                        <img src="assets/images/apple-icon-57x57.png">
                    </div>

                </a>
                <a class="mobile-menu" id="mobile-collapse" href="javascript:"><span></span></a>
            </div>
            <div class="navbar-content scroll-div">
                <ul class="nav pcoded-inner-navbar">
                    <li class="nav-item pcoded-menu-caption">
                        <label>Navigation</label>
                    </li>
                    <li data-username="dashboard Default Ecommerce CRM Analytics Crypto Project" class="nav-item active">
                        <a href="index.html" class="nav-link "><span class="pcoded-micon"><i class="feather icon-grid"></i></span><span class="pcoded-mtext">Dashboard</span></a>
                    </li>
                    <li data-username="dashboard Default Ecommerce CRM Analytics Crypto Project" class="nav-item active">
                        <a href="faucet.html" class="nav-link "><span class="pcoded-micon"><i class="feather icon-battery-charging"></i></span><span class="pcoded-mtext">Faucet</span></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- [ navigation menu ] end -->

    <!-- [ Header ] start -->
    <header class="navbar pcoded-header navbar-expand-lg navbar-light">
        <div class="m-header">
            <a class="mobile-menu" id="mobile-collapse1" href="javascript:"><span></span></a>
            <a href="index.html" class="b-brand">
                   <div class="b-bg">
                       
                   </div>
                   
               </a>
        </div>
        <a class="mobile-menu" id="mobile-header" href="javascript:">
            <i class="feather icon-more-horizontal"></i>
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li><a href="javascript:" class="full-screen" onclick="javascript:toggleFullScreen()"><i class="feather icon-maximize"></i></a></li>
                <li><button type="button" id="connect_web_3" class="btn btn-dark">Connect Web 3</button> </li>
                <li><span id="show_wallet"></span></li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li>
                    
                </li>
                <li>
                   
                </li>
            </ul>
        </div>
    </header>
    <!-- [ Header ] end -->

    <!-- [ Main Content ] start -->
    <div class="pcoded-main-container">
        <div class="pcoded-wrapper">
            <div class="pcoded-content">
                <div class="pcoded-inner-content">
                    <!-- [ breadcrumb ] start -->

                    <!-- [ breadcrumb ] end -->
                    <div class="main-body">
                        <div class="page-wrapper">
                            <!-- [ Main Content ] start -->
                            <div class="row">
                                <!--[ daily sales section ] start-->
                                <div class="col-md-6 col-xl-8">
                                    <div class="card daily-sales">
                                        <div class="card-block">
                                            <h6 class="mb-4">Search</h6>
                                            <div class="row d-flex align-items-center">
                                                <div class="col-9">
                                                    <input type="text" id="search_field" class="form-control" placeholder="Enter search term">
                                                </div>

                                                <div class="col-3 text-right">
                                                   <button type="button" id="search_button" class="btn btn-primary" >Search <i class="feather icon-search"></i></button>
                                                </div>
                                            </div>
                                            <div> 
                                                <label for="search_type">Search Type</label>
                                                <select id="search_type" class="form-control">
                                                    <option value="default">Default</option>
                                                    <option value="premium">Premium</option>
                                                </select>
                                                <span id="premium_search_fee_display"></span>
                                                <span id="premium_search_approve_button_span"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             
                                <!--[ Monthly  sales section ] end-->
                                <!--[ year  sales section ] starts-->
                                <div class="col-md-12 col-xl-2">
                                    <div class="card yearly-sales">
                                        <div class="card-block">
                                            <h6 class="mb-4">Your Document Count</h6>
                                            <div class="row d-flex align-items-center">
                                                <div class="col-9">
                                                    <h3 class="f-w-300 d-flex align-items-center  m-b-0"><span id="document_count_display"></span></h3>
                                                </div>
                                                <div class="col-3 text-right">
                                                    
                                                </div>
                                            </div>
                                            <div >
                                                Earnings to date: <span id="earnings_display"></span>
                                            </div>
                                            <div >
                                                Withdrawals to date: -<span id="withdrawn_earnings_display"></span>
                                            </div>
                                            <div>
                                                <button type="button" id="withdraw_button" class="btn btn-danger">Withdraw Funds</button>
                                            </div> 
                                            <span id="withdrawn_earnings_display_span"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 col-xl-2">
                                    <div class="card yearly-sales">
                                        <div class="card-block">
                                            <h6 class="mb-4">Your Document Earnings</h6>
                                            <div class="row d-flex align-items-center">
                                                <div class="col-9">
                                                    <h3 class="f-w-300 d-flex align-items-center  m-b-0">
                                                        <input type="text" id="view_document_earnings_field" class="form-control" placeholder="enter document ref">
                                                    </h3>
                                                </div>
                                                <div class="col-3 text-right">
                                                   
                                                </div>
                                            </div>
                                            <br/>
                                            <div >
                                                Earnings to date:<h5><span id="document_earnings_display"></span></h5>
                                            </div>
                                            <div>
                                                <br/>
                                            </div>
                                            <div>
                                                <button id="view_document_earnings_button" type="button" class="btn btn-success">View Document Earnings</button>
                                            </div> 
                                        </div>
                                    </div>
                                </div>
                                <!--[ year  sales section ] end-->
                                <div class="col-md-6 col-xl-4">
                                    <div class="card daily-sales">
                                        <div class="card-block">
                                            <h6 class="mb-4">View Premium Document</h6>
                                            <div class="row d-flex align-items-center">
                                                <div class="col-9">
                                                    <input type="text" id="premium_document_ref_field" class="form-control" placeholder="Enter document ref field ">
                                                </div>
                                                <div class="col-3 text-right">
                                                   
                                                </div>
                                            </div>
                                            <div> 
                                                <label for="premium_document_view_price">Document View Fee</label>
                                                <span id="premium_document_view_price_display"></span>
                                                <br/>
                                                <button type="button" id="approve_premium_button" class="btn btn-primary" >Approve <i class="feather icon-thumbs-up"></i></button>
                                                <button type="button" id="view_premium_button" class="btn btn-success" >View <i class="feather icon-eye"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6 col-xl-4">
                                    <div class="card daily-sales">
                                        <div class="card-block">
                                            <h6 class="mb-4">Find my document</h6>
                                            <div class="row d-flex align-items-center">
                                                <div class="col-9">
                                                    <input type="text" id="find_document_field" class="form-control" placeholder="Enter document ref field">
                                                </div>

                                                <div class="col-3 text-right">
                                                   <button type="button" id="find_button" class="btn btn-primary" >Find <i class="feather icon-search"></i></button>
                                                </div>
                                            </div>
                                            <div>   
                                                <h6 class="mb-4">Delete Document</h6>
                                                <div class="row d-flex align-items-center">
                                                    <div class="col-9">                                                    
                                                        <input type="text" id="document_delete_ref" class="form-control" placeholder="Enter document ref">
                                                    </div>
                                                    <div class="col-3 text-right">
                                                       <button type="button" id="document_delete_button" class="btn btn-danger" >Delete <i class="feather icon-trash"></i></button>
                                                    </div>
                                                    <span id="document_delete_display_span"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             
                                <div class="col-md-6 col-xl-2">
                                    <div class="card daily-sales">
                                        <div class="card-block">
                                         
                                            <div>                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xl-2">
                                    <div class="card daily-sales">
                                        <div class="card-block">                                         
                                            <div>               
                                                <h6 class="mb-2">Get View Price</h6>
                                                <div class="row d-flex align-items-center">
                                                    <div class="col-9">                                                    
                                                        <input type="text" id="document_price_ref" class="form-control" placeholder="Enter document ref">
                                                        <button type="button" id="document_price_button" class="btn btn-info" >Get Price <i class="feather icon-file"></i></button>
                                                    </div>
                                                    <div class="col-3 text-right">
                                                       
                                                    </div>
                                                    <span id="document_price_display"></span>
                                                </div>                                 
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!--[ Recent Users ] start-->                                
                                <div class="col-xl-8 col-md-6">
                                    <div class="card Recent-Users">
                                        <div class="card-header">
                                            <h5>Search Results</h5>
                                            <span id="available_documents_display"></span>
                                            <span id="retrieve_price_display"></span>
                                        </div>
                                        <div class="card-block px-0 py-3">
                                            <div class="table-responsive">
                                                <table class="table table-hover" id="document_results_table">
                      
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--[ Recent Users ] end-->

                                <!-- [ statistics year chart ] start -->
                                <div class="col-xl-4 col-md-6">
                                    <div class="card card-event">
                                        <div class="card-block">
                                            <div class="row align-items-center justify-content-center">
                                                <div class="col">
                                                    <h5 class="m-0">Upload new files</h5>
                                                </div>                                                
                                            </div>
                                            <div class="col">
                                                <label for="upload_title">Upload Title</label>                                                        
                                                <input type="text" id="upload_title" class="form-control" placeholder="enter upload title">
                                            </div>
                                            <div class="col-auto">
                                                <label for="upload_file">Upload Search Terms</label>
                                                <input type="text" id="upload_search_terms" class="form-control" placeholder="enter upload searh terms comma separated ">
                                            </div>
                                            <div class="col-auto">
                                                <label for="upload_view_price">View Price</label>
                                                <input type="text" id="upload_view_price" class="form-control" placeholder="enter upload view price ">
                                            </div>
                                            <div class="col-auto">
                                                <label for="upload_file">Upload File</label>
                                                <input type="file" id="upload_file" class="form-control">
                                            </div>
                                            <br/>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-success" id="upload_file_button">Upload</button>
                                            </div>
                                            <span id="upload_status_span"></span>                                                                      
                                        </div>
                                    </div>
                                    
                                </div>
                                <!-- [ statistics year chart ] end -->
                               

                            </div>
                            <!-- [ Main Content ] end -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- [ Main Content ] end -->

    <!-- Warning Section Starts -->
    <!-- Older IE warning message -->
    <!--[if lt IE 11]>
        <div class="ie-warning">
            <h1>Warning!!</h1>
            <p>You are using an outdated version of Internet Explorer, please upgrade
               <br/>to any of the following web browsers to access this website.
            </p>
            <div class="iew-container">
                <ul class="iew-download">
                    <li>
                        <a href="http://www.google.com/chrome/">
                            <img src="assets/images/browser/chrome.png" alt="Chrome">
                            <div>Chrome</div>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.mozilla.org/en-US/firefox/new/">
                            <img src="assets/images/browser/firefox.png" alt="Firefox">
                            <div>Firefox</div>
                        </a>
                    </li>
                    <li>
                        <a href="http://www.opera.com">
                            <img src="assets/images/browser/opera.png" alt="Opera">
                            <div>Opera</div>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.apple.com/safari/">
                            <img src="assets/images/browser/safari.png" alt="Safari">
                            <div>Safari</div>
                        </a>
                    </li>
                    <li>
                        <a href="http://windows.microsoft.com/en-us/internet-explorer/download-ie">
                            <img src="assets/images/browser/ie.png" alt="">
                            <div>IE (11 & above)</div>
                        </a>
                    </li>
                </ul>
            </div>
            <p>Sorry for the inconvenience!</p>
        </div>
    <![endif]-->
    <!-- Warning Section Ends -->

    <!-- Required Js -->
    <script src="assets/js/vendor-all.min.js"></script>
	<script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/pcoded.min.js"></script>
    <script src="assets/js/iAnvetiAbi.js"></script>
    <script src="assets/js/iErc20Abi.js"></script>

    <script> 
  

        const onboardButton                     = ge("connect_web_3");
        const showWallet                        = ge("show_wallet");        

        const generalSearchField                = ge("search_field");
        const generalSearchButton               = ge("search_button");
        const generalSearchType                 = ge("search_type"); 
        const premiumSearchApproveButtonSpan    = ge("premium_search_approve_button_span");
        
        generalSearchType.addEventListener('click', showPremiumFee);
        generalSearchButton.addEventListener('click', search);
        
        const premiumSearchFeeDisplay           = ge("premium_search_fee_display");
        
        var premiumSearchApproveButton;                 

        function premiumSearchApprove() { 
            anvetiContract.methods.getPremiumSearchPrice().call({from : account})
            .then(function(response){
                console.log(response);

            })
            .catch(function(err){
                console.log(err);
            });
        }
        
        const availableDocumentsDisplay         = ge("available_documents_display");
        const retrievePriceDisplay              = ge("retrieve_price_display");

        const documentCountDisplay              = ge("document_count_display");
        const earningsDisplay                   = ge("earnings_display");
        const withdrawnEarningsDisplay          = ge("withdrawn_earnings_display");
        const withdrawButton                    = ge("withdraw_button");
        const withdrawnEarningsDisplaySpan      = ge("withdrawn_earnings_display_span");
        withdrawButton.addEventListener('click', withdraw);


        const viewDocumentEarningsField         = ge("view_document_earnings_field"); 
        const documentEarningsDisplay           = ge("document_earnings_display");
        const viewDocumentEarningsButton        = ge("view_document_earnings_button");
        viewDocumentEarningsButton.addEventListener('click', viewDocumentEarnings); 
        
        const documentPriceField                = ge("document_price_ref");
        const documentPriceButton               = ge("document_price_button");
        const documentPriceDisplay              = ge("document_price_display");
        documentPriceButton.addEventListener('click', viewDocumentPrice);

        
        const premiumDocumentRefField           = ge("premium_document_ref_field");
        const premiumDocumentViewPriceDisplay   = ge("premium_document_view_price_display");
        const approvePremiumButton              = ge("approve_premium_button");
        const viewPremiumButton               = ge("view_premium_button");
        viewPremiumButton.addEventListener('click', viewPremium);

        const findDocumentField                 = ge("find_document_field");
        const findButton                        = ge("find_button");
        findButton.addEventListener('click', find);


        const documentDeleteRef                 = ge("document_delete_ref");
        const documentDeleteButton              = ge("document_delete_button");
        const documentDeleteDisplaySpan         = ge("document_delete_display_span");
        documentDeleteButton.addEventListener('click', deleteDocument);


        const documentResultsTable              = ge("document_results_table");

        const uploadTitle                       = ge("upload_title");
        const uploadSearchTerms                 = ge("upload_search_terms"); 
        const uploadViewPrice                   = ge("upload_view_price");
        const uploadFile                        = ge("upload_file");

        const uploadFileButton                  = ge("upload_file_button");
        const uploadStatusSpan                = ge("upload_status_span");
        uploadFileButton.addEventListener('click', upload);

        //========================== FUNCTIONS ====================

        const web3 = new Web3(window.ethereum);

        const anvetiAddress = "0xc65f0EFD331Ee06A91EEa540C30E881616615ffa";
        const anvetiContract = new web3.eth.Contract(iAnvetiAbi, anvetiAddress);

        const ierc20Address = "0x8A771Ad05172cA1ADee6d233a907Fc1E7797b201";
        const ierc20Contract = new web3.eth.Contract(iErc20Abi, ierc20Address);

        const ipfs = window.IpfsHttpClientLite('https://ipfs.infura.io:5001')
        const buffer = window.IpfsHttpClientLite.Buffer;
        console.log("got ipfs: " + ipfs);

        var searchRetrieveFee = 0;  

        //Created check function to see if the MetaMask extension is installed
        const isMetaMaskInstalled = () => {

            const {
                ethereum
            } = window;
            return Boolean(ethereum && ethereum.isMetaMask);
        };

        const MetaMaskClientCheck = () => {
            //Now we check to see if Metmask is installed
            if (!isMetaMaskInstalled()) {
                console.log("metamask not installed");
                //If it isn't installed we ask the user to click to install it
                onboardButton.innerText = 'Click here to install MetaMask!';
                //When the button is clicked we call this function
                onboardButton.onclick = onClickInstall;
                //The button is now disabled
                onboardButton.disabled = false;
            } else {
                //If it is installed we change our button text
                onboardButton.innerText = 'Click to Connect Metamask';

                console.log("metamask installed");
                onboardButton.addEventListener('click', () => {
                    getAccount();
                    onboardButton.innerText = "Web 3 Connected";
                });
            }
        };
        const initialize = () => {
            MetaMaskClientCheck();
        };

        window.addEventListener('DOMContentLoaded', initialize);

        async function getAccount() {
            const accounts = await ethereum.request({
                method: 'eth_requestAccounts'
            });
            account = accounts[0];
            showWallet.innerHTML = "<b>Connected Wallet :: " + account + "</b>";
            loadStats();
        }

        //We create a new MetaMask onboarding object to use in our app
        //const onboarding = new MetaMaskOnboarding({ forwarderOrigin });

        //This will start the onboarding proccess
        const onClickInstall = () => {
            onboardButton.innerText = 'Onboarding in progress';
            onboardButton.disabled = true;
            //On this object we have startOnboarding which will start the onboarding process for our end user
            onboarding.startOnboarding();
        };

        const onClickConnect = async() => {
            try {
                // Will open the MetaMask UI
                // You should disable this button while the request is pending!
                await ethereum.request({
                    method: 'eth_requestAccounts'
                });
            } catch (error) {
                console.error(error);
            }
        };

        function loadStats() {
            anvetiContract.methods.getDocumentCount().call({from : account}) 
            .then(function(response){
                console.log(response);
                documentCountDisplay.innerHTML = response; 
            })
            .catch(function(err){
                console.log(err);
            });

            anvetiContract.methods.getEarnings().call({from : account})
            .then(function(response){
                console.log(response);
                earningsDisplay.innerHTML = response;            
            })
            .catch(function(err){
                console.log(err);
            });

            anvetiContract.methods.withdrawEarnings().call({from : account})
            .then(function(response){
                withdrawnEarningsDisplay.innerHTML = response; 
            })
            .catch(function(err){
                console.log(err);
            });
        
        }
        
        function viewDocumentPrice() { 
            var docRef = documentPriceField.value; 
            anvetiContract.methods.getViewPrice(docRef).call({from : account})
            .then(function(response){
                console.log(response);
                documentPriceDisplay.innerHTML = "<center> <h4> PRICE ::"+response+"</h4></center>"
            })
            .catch(function(err){
                console.log(err);
            });
        }

        async function deleteDocument() { 
            var docRef = documentDeleteRef.value; 
            anvetiContract.methods.find(docRef).send({from : account})
            .then(function(response){
                console.log(response);
                documentDeleteDisplaySpan.innerHTML = " Deleted Doc :: "+docRef+" : " + response; 
            })
            .catch(function(err){
                console.log(err);
            });
        }


        async function withdraw() { 
            anvetiContract.methods.withdrawEarnings().send({from : account})
            .then(function(response){
                console.log(response);
                withdrawnEarningsDisplaySpan.innerHTML = "Withdrawn :: " +response; 
                loadStats();
            })
            .catch(function(err){
                console.log(err);
            });
        }


        async function viewDocumentEarnings() {
            var docRef = viewDocumentEarningsField.value; 
            anvetiContract.methods.getDocumentEarnings(docRef).call({from : account})
            .then(function(response){
                console.log(response);
                documentEarningsDisplay.innerHTML = response; 
            })
            .catch(function(err){
                console.log(err);
            });
        }

        async function find() { 
            var docRef = findDocumentField.value;
            anvetiContract.methods.findDocument(docRef).call({from : account})
            .then(function(response){
                console.log(response);
                window.open("http://ipfs.io/ipfs/"+response); 
                findDocumentField.value = "";
            })
            .catch(function(err){
                console.log(err);
            });
        }


        async function viewPremium() { 
            var docRef =premiumDocumentRefField.value;
            anvetiContract.methods.getViewPrice(docRef).call({from : account})
            .then(function(response){     
                console.log(response);       
                var viewPrice = response; 
                var docRef = premiumDocumentRefField.value;
                anvetiContract.methods.viewDocument(docRef, viewPrice).call({from : account})
                .then(function(response){
                    console.log(response);
                    window.open("http://ipfs.io/ipfs/"+response);                    
                })
                .catch(function(err){
                    console.log(err);
                }); 
            })
            .catch(function(err){
               console.log(err);
            });
        }

        async  function showPremiumFee() { 
            if(generalSearchType.value === 'premium'){
                anvetiContract.methods.getPremiumSearchPrice().call({from : account})
                .then(function(response){
                    console.log(response);
                    premiumSearchFeeDisplay.innerHTML = "<div> Premium Search Fee: "+response+"</div>"; 
                    premiumSearchApproveButtonSpan.innerHTML = "<button type=\"button\" id=\"premium_search_approve_button\" class=\"btn btn-primary\">Approve <i class=\"feather icon-thumbs-up\"></i></button>";                   
                    premiumSearchApproveButton = ge("premium_search_approve_button");
                    premiumSearchApproveButton.addEventListener('click', premiumSearchApprove); 
                })  
                .catch(function(err){
                    console.log(err);
                });
            }
            else { 
                premiumSearchFeeDisplay.innerHTML = "";
                premiumSearchApproveButtonSpan.innerHTML = "";
            }
        }

        async function upload() { 

            ipfs.add(uploadFile.files[0])
            .then(function(response) {
                console.log(response);
                var ipfsHash =  ""+response[0].hash;
                console.log(ipfsHash);
                

                console.log(uploadTitle);

                var title = uploadTitle.value; 
                var terms = uploadSearchTerms.value.split(",");
                console.log(terms);
                var viewPrice = uploadViewPrice.value; 

                anvetiContract.methods.uploadDocument(title, ipfsHash, terms, viewPrice).send({from : account})
                .then(function(response){
                    console.log(response);
                    uploadStatusSpan.innerHTML = "<a href=\"https://rinkeby.etherscan.io/tx/"+response.blockHash+"\">"+response.blockHash+"</a>";
                    clearUpload(); 
                })
                .catch(function(err){
                    console.log(err);
                });
            })
            .catch(function(err) {
                console.log(err);
            })
        }

        function clearUpload() { 
            uploadFile.value =""; 
            uploadTitle.value = "";
            uploadSearchTerms.value = ""; 
            uploadViewPrice.value = "";
        }

        async function search() {
            var searchType = generalSearchType.value; 
            if(searchType === 'default') {
                var term = generalSearchField.value; 
                console.log(term)
                anvetiContract.methods.search(term).call({from : account})
                .then(function(response){
                    console.log(response);

                    var refs = response._ref; 
                    var titles = response._title; 
                    var uploadDates = response._uploadDate; 
                    var ipfsHashs = response._ipfsHash;
                    availableDocumentsDisplay.innerHTML =  response._availableDocuments; 
                    retrievePriceDisplay.innerHTML = response._retrievePrice; 
                    for(var x = 0; x < refs.length; x++){
                        var row = documentResultsTable.insertRow();
                        createStandardRow (row, refs[x], titles[x], uploadDates[x], ipfsHashs[x]);
                    }                    
                })
                .catch(function(err){
                    console.log(err);
                });
            }

            if(searchType === 'premium'){
                var term = generalSearchField.value; 
                anvetiContract.methods.search(term, fee).call({from : account})
                .then(function(response){
                    console.log(response);
                    clearTable(ddocumentResultsTable);
                    availableDocumentsDisplay.innerHTML = "";
                    retrievePriceDisplay.innerHTML = "";
                    var refs = response._ref; 
                    var titles = response._title; 
                    var uploadDates = response._uploadDate; 
                    var viewPrices = response._viewPrice; 
                    for(var x = 0; x < refs.length; x++){
                        var row = ddocumentResultsTable.insertRow();
                        createPremiumRow (row, refs[x], title[x], uploadDate[x], viewPrices[x]);
                    }                    
                })
                .catch(function(err){
                    console.log(err);
                });
            }
        }


        async function createStandardRow (row, ref, title, uploadDate, ipfsHash){ 
            var refCell = getCell(row);
            var titleCell = getCell(row);
            var uploadDateCell = getCell(row);

            var refCell = getCell(row);
            var h6 = ce("h6");
            h6.setAttribute("class", "text-muted");
            refCell.appendChild(h6);
            var refTxt = text(ref);
            h6.append(refTxt);
            
            var titleCell = getCell(row);
            var h6t = ce("h6");
            titleCell.append(h6t);
            h6t.setAttribute("class", "text-muted");
            titleCell.append(h6t);
            var titleTxt = text(title);
            h6t.append(titleTxt);

            var uploadDateCell = getCell(row);            
            var h6u = ce("h6");
            uploadDateCell.append(h6u);
            h6u.setAttribute("class", "text-muted");
            uploadDateCell.append(h6u);
            var dateTxt = text((new Date(uploadDate*1000)).toISOString());
            h6u.append(dateTxt);
            
            var ipfsHashCell = getCell(row);
            var h6v = ce("h6");
            ipfsHashCell.append(h6v);            
            h6v.setAttribute("class", "text-muted");            
            var a = ce("a");
            h6v.append(a);  
            a.setAttribute("href", "http://ipfs.io/ipfs/"+ipfsHash);
            a.setAttribute("target","_blank");
            var hashTxt = text(ipfsHash);
            a.append(hashTxt);        
        }

        async function createPremiumRow(row,ref, title, uploadDate, viewPrice){
            var refCell = getCell(row);
            var h6 = ce("h6");
            h6.setAttribute("class", "text-muted");
            refCell.appendChild(h6);
            var refTxt = text(ref);
            h6.appendChild(refTxt);
            
            var titleCell = getCell(row);
            var h6t = ce("h6");
            h6t.setAttribute("class", "text-muted");
            titleCell.appendChild(h6t);
            var titleTxt = text(title);
            h6t.appendChild(titleTxt);

            var uploadDateCell = getCell(row);            
            var h6u = ce("h6");
            h6u.setAttribute("class", "text-muted");
            uploadDateCell.appendChild(h6u);
            var dateTxt = text((new Date(uploadDate*1000)).toISOString());
            h6u.appendChild(dateTxt);
            
            var viewPriceCell = getCell(row);
            var h6v = ce("h6");
            viewPriceCell.appendChild(h6v);            
            h6v.setAttribute("class", "text-muted");            
            var viewTxt = text(viewPrice);
            h6v.aappendChild(viewTxt);                            
        }

        function getCell(row) {
            var cell = row.insertCell(); 
            return cell; 
        }

        function ce(element){
            return document.createElement(element);
        }

        function text(txt) {
            return document.createTextNode(txt);
        }

        function ge(element) {
            return document.getElementById(element); 
        }

        function clearTable(table) {
            table.innerHTML = "";
        }

    </script>

</body>
</html>
